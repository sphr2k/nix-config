#!/usr/bin/env bash
set -euo pipefail

image="dotfiles-ubuntu-nix:24.04"
repo_root="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

usage() {
  cat <<'EOF'
usage:
  test-ubuntu-2404 [--shell] [--no-build]

what it does:
  - builds a container image from nixos/nix (git installed at first run)
  - mounts this repo at /src/dotfiles
  - runs with seccomp=unconfined so nix can run (required on OrbStack/Docker)
  - by default runs:
      nix flake check
      nix build .#packages.x86_64-linux.dockerTarball

options:
  --shell     start an interactive bash in the container
  --no-build  skip the nix build step (still runs flake check unless --shell)
EOF
}

shell=false
no_build=false

while [[ $# -gt 0 ]]; do
  case "$1" in
    --shell) shell=true; shift ;;
    --no-build) no_build=true; shift ;;
    -h|--help) usage; exit 0 ;;
    *) echo "unknown arg: $1" >&2; usage; exit 2 ;;
  esac
done

docker build --platform linux/amd64 -t "$image" - <<'DOCKERFILE'
# Official Nix image (no nix build during docker build - seccomp fails in OrbStack/Docker)
FROM nixos/nix:latest

# Disable sandbox so nix works at runtime under Docker/OrbStack seccomp
RUN echo 'sandbox = false' >> /etc/nix/nix.conf
ENV NIX_CONFIG="sandbox = false"

# homeConfigurations.nix@ubuntu expects user nix and HOME=/home/nix (create without useradd/adduser)
RUN echo 'nix:x:1000:1000:nix user:/home/nix:/bin/bash' >> /etc/passwd && \
    echo 'nix:x:1000:' >> /etc/group && \
    mkdir -p /home/nix && chown 1000:1000 /home/nix
WORKDIR /src/dotfiles
# run as root so nix is on PATH; we set HOME=/home/nix when running activation
DOCKERFILE

# Install git on first run (needs seccomp=unconfined); then run the actual command
bootstrap='nix-env -iA nixpkgs.git 2>/dev/null || true'
run_cmd=( bash -lc )

if "$shell"; then
  run_cmd+=("$bootstrap && echo 'Setting up home environment...' && chown root:root /home/nix && HOME=/home/nix nix --extra-experimental-features 'nix-command flakes' run .#homeConfigurations.nix@ubuntu.activationPackage && chown -R 1000:1000 /home/nix && echo 'Home environment ready!' && exec su - nix")
else
  if "$no_build"; then
    run_cmd+=("$bootstrap && nix --extra-experimental-features 'nix-command flakes' flake check")
  else
    run_cmd+=("$bootstrap && nix --extra-experimental-features 'nix-command flakes' flake check && nix --extra-experimental-features 'nix-command flakes' build .#packages.x86_64-linux.dockerTarball")
  fi
fi

docker_flags="--rm --security-opt seccomp=unconfined"
if [ -t 0 ] && [ -t 1 ]; then
  docker_flags="--rm -it --security-opt seccomp=unconfined"
fi

exec docker run --platform linux/amd64 $docker_flags \
  -v "$repo_root:/src/dotfiles" \
  "$image" \
  "${run_cmd[@]}"

